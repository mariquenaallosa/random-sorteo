<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sorteador de listas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <meta name="color-scheme" content="dark" />
  </head>
  <body class="min-h-screen bg-neutral-900 text-neutral-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const { useEffect, useMemo, useRef, useState } = React;

      const STORAGE_KEY = "sorteador_listas_v1";

      const saveToStorage = (data) => {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
      };
      const loadFromStorage = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      };

      // ‚úÖ corregido
      const parseLines = (text) =>
        text.split(/\r?\n/).map((s) => s.trim()).filter(Boolean);

      const download = (filename, content, type = "text/plain") => {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
      };
      const copy = (text) => navigator.clipboard.writeText(text);

      const initialState = { items: [], drawn: [], history: [] };

      function dedupe(items, drawn) {
        const set = new Set(drawn);
        const out = [];
        for (const it of items) { if (it && !set.has(it) && !out.includes(it)) out.push(it); }
        return out;
      }

      function seededRandomIndex(length, seed) {
        if (!seed) return Math.floor(Math.random() * length);
        let h = 2166136261 >>> 0;
        for (let i = 0; i < seed.length; i++) { h ^= seed.charCodeAt(i); h = Math.imul(h, 16777619); }
        let x = h || 1; x ^= x << 13; x >>>= 0; x ^= x >> 17; x >>>= 0; x ^= x << 5; x >>>= 0;
        const rnd = (x >>> 0) / 0xffffffff; return Math.floor(rnd * length);
      }

      function toast(msg, ms = 1200) {
        const el = document.createElement("div");
        el.textContent = msg;
        Object.assign(el.style, {
          position:"fixed", bottom:"16px", left:"50%", transform:"translateX(-50%)",
          padding:"8px 12px", background:"rgba(255,255,255,0.9)", color:"#111",
          borderRadius:"12px", fontSize:"12px", zIndex:9999
        });
        document.body.appendChild(el); setTimeout(()=>el.remove(), ms);
      }

      function Card({ title, value }) {
        return (
          <div className="rounded-2xl bg-neutral-800 p-4">
            <div className="text-sm text-neutral-400">{title}</div>
            <div className="text-2xl font-bold">{value}</div>
          </div>
        );
      }

      function ListPanel({ title, items, emptyHint, onRemove }) {
        return (
          <div className="rounded-2xl bg-neutral-800 p-4">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-semibold">{title}</h3>
              {items.length > 0 && <div className="text-xs text-neutral-400">Click en üóëÔ∏è para quitar manualmente</div>}
            </div>
            {items.length === 0 ? (
              <div className="text-sm text-neutral-400">{emptyHint}</div>
            ) : (
              <ul className="max-h-80 overflow-auto space-y-2 pr-1">
                {items.map((it, idx) => (
                  <li key={idx} className="flex items-center justify-between gap-2 bg-neutral-900 rounded-xl px-3 py-2 border border-neutral-700">
                    <span className="truncate" title={it}>{it}</span>
                    <button
                      onClick={() => onRemove(idx)}
                      className="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-neutral-800 hover:bg-neutral-700"
                      aria-label={`Eliminar ${it}`}
                    >
                      üóëÔ∏è
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        );
      }

      function App() {
        const [state, setState] = useState(() => loadFromStorage() ?? initialState);
        const [bulkText, setBulkText] = useState("");
        the
        const [newItem, setNewItem] = useState("");
        const [lastWinner, setLastWinner] = useState(null);
        const [seed, setSeed] = useState("");
        const winnerRef = useRef(null);

        useEffect(() => { saveToStorage(state); }, [state]);

        const total = state.items.length + state.drawn.length;

        const addItemsFromText = () => {
          const lines = Array.from(new Set(parseLines(bulkText)));
          if (!lines.length) return;
          setState((s) => ({ ...s, items: dedupe([...s.items, ...lines], s.drawn) }));
          setBulkText("");
        };
        const addSingleItem = () => {
          const v = newItem.trim(); if (!v) return;
          setState((s) => ({ ...s, items: dedupe([...s.items, v], s.drawn) }));
          setNewItem("");
        };
        const removeItem = (idx) => setState((s) => ({ ...s, items: s.items.filter((_, i) => i !== idx) }));
        const removeDrawn = (idx) => setState((s) => ({ ...s, drawn: s.drawn.filter((_, i) => i !== idx) }));
        const clearAll = () => {
          if (!confirm("¬øReiniciar todo? Se perder√° el historial de sorteos.")) return;
          setState(initialState); setLastWinner(null); setSeed("");
        };
        const undo = () => {
          setState((s) => {
            const last = s.history[s.history.length - 1];
            if (!last) return s;
            return { items: [last, ...s.items], drawn: s.drawn.filter((x) => x !== last), history: s.history.slice(0, -1) };
          });
          setLastWinner(null);
        };
        const pickRandom = () => {
          setLastWinner(null);
          setState((s) => {
            if (!s.items.length) return s;
            const idx = seededRandomIndex(s.items.length, seed);
            const winner = s.items[idx];
            const nextItems = s.items.filter((_, i) => i !== idx);
            const nextDrawn = [winner, ...s.drawn];
            setLastWinner(winner);
            queueMicrotask(() => winnerRef.current?.scrollIntoView({ behavior: "smooth", block: "center" }));
            return { items: nextItems, drawn: nextDrawn, history: [...s.history, winner] };
          });
        };
        const exportCSV = () => {
          const rows = [["estado","valor"], ...state.items.map((v)=>["pendiente", v]), ...state.drawn.map((v)=>["sorteado", v])];
          // ‚úÖ corregido
          const csv = rows.map((r)=>r.map((c)=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");
          download("sorteador.csv", csv, "text/csv");
        };
        const importFile = (file) => {
          const reader = new FileReader();
          reader.onload = () => {
            const text = String(reader.result ?? "");
            const lines = parseLines(text);
            setState((s) => ({ ...s, items: dedupe([...s.items, ...lines], s.drawn) }));
          };
          reader.readAsText(file);
        };

        const canPick = state.items.length > 0;
        const stats = useMemo(() => ({
          total,
          pendientes: state.items.length,
          sorteados: state.drawn.length,
          progreso: total ? Math.round((state.drawn.length / total) * 100) : 0,
        }), [total, state.items.length, state.drawn.length]);

        return (
          <div className="min-h-screen bg-neutral-900 text-neutral-100 p-4 md:p-8">
            <div className="max-w-6xl mx-auto grid gap-6">
              <header className="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Sorteador de listas</h1>
                <div className="flex flex-wrap items-center gap-2">
                  <button onClick={clearAll} className="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-neutral-800 hover:bg-neutral-700">üîÑ Reiniciar</button>
                  <button onClick={undo} className="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-neutral-800 hover:bg-neutral-700">‚Ü©Ô∏è Deshacer</button>
                  <button onClick={exportCSV} className="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-neutral-800 hover:bg-neutral-700">‚¨áÔ∏è Exportar CSV</button>
                  <label className="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-neutral-800 hover:bg-neutral-700 cursor-pointer">
                    ‚¨ÜÔ∏è Importar .txt/.csv
                    <input type="file" className="hidden" accept=".txt,.csv,.tsv" onChange={(e) => e.target.files?.[0] && importFile(e.target.files[0])} />
                  </label>
                </div>
              </header>

              <section className="grid md:grid-cols-4 gap-3">
                <Card title="Total" value={stats.total} />
                <Card title="Pendientes" value={stats.pendientes} />
                <Card title="Sorteados" value={stats.sorteados} />
                <div className="rounded-2xl bg-neutral-800 p-4">
                  <div className="text-sm text-neutral-400 mb-2">Progreso</div>
                  <div className="h-3 bg-neutral-700 rounded-full overflow-hidden">
                    <div className="h-full bg-white/80" style={{ width: `${stats.progreso}%` }} />
                  </div>
                  <div className="text-right text-sm mt-1">{stats.progreso}%</div>
                </div>
              </section>

              <section className="grid md:grid-cols-2 gap-6">
                <div className="rounded-2xl bg-neutral-800 p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold">Pegar lista (uno por l√≠nea)</h2>
                    <button onClick={addItemsFromText} className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white text-neutral-900 font-medium hover:bg-white/90">‚ûï Cargar</button>
                  </div>
                  <textarea
                    className="w-full h-40 rounded-xl p-3 bg-neutral-900 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-white/30"
                    placeholder={`Ej.:\nAna\nLuis\nCarla`}
                    value={bulkText}
                    onChange={(e) => setBulkText(e.target.value)}
                  />
                  <div className="text-xs text-neutral-400 mt-2">Se eliminan duplicados y l√≠neas vac√≠as autom√°ticamente.</div>
                </div>

                <div className="rounded-2xl bg-neutral-800 p-4 grid gap-4">
                  <div>
                    <div className="text-sm text-neutral-300 mb-1">Agregar elemento r√°pido</div>
                    <div className="flex gap-2">
                      <input
                        className="flex-1 rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-white/30"
                        placeholder="Nombre / √≠tem"
                        value={newItem}
                        onChange={(e) => setNewItem(e.target.value)}
                        onKeyDown={(e) => e.key === "Enter" && addSingleItem()}
                      />
                      <button onClick={addSingleItem} className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white text-neutral-900 font-medium hover:bg-white/90">‚ûï Agregar</button>
                    </div>
                  </div>

                  <div>
                    <div className="text-sm text-neutral-300 mb-1">Semilla (opcional, para reproducir el sorteo)</div>
                    <input
                      className="w-full rounded-xl px-3 py-2 bg-neutral-900 border border-neutral-700 focus:outline-none focus:ring-2 focus:ring-white/30"
                      placeholder="Cualquier texto o n√∫mero"
                      value={seed}
                      onChange={(e) => setSeed(e.target.value)}
                    />
                    <div className="text-xs text-neutral-400 mt-1">Si defines una semilla y el orden de la lista es el mismo, el resultado ser√° reproducible.</div>
                  </div>

                  <button
                    onClick={pickRandom}
                    disabled={!canPick}
                    className="inline-flex justify-center items-center gap-2 px-4 py-3 rounded-2xl bg-emerald-400 text-neutral-900 font-semibold disabled:opacity-50 hover:bg-emerald-300"
                  >
                    ‚ñ∂Ô∏è ¬°Sortear!
                  </button>

                  {lastWinner && (
                    <div ref={winnerRef} className="rounded-2xl border border-emerald-400/40 bg-emerald-400/10 p-4">
                      <div className="text-sm text-neutral-300 mb-1">Ganador/a</div>
                      <div className="flex items-center justify-between gap-3">
                        <div className="text-2xl font-bold">{lastWinner}</div>
                        <button
                          onClick={() => copy(lastWinner).then(() => toast("Copiado"))}
                          className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800"
                        >üìã Copiar</button>
                      </div>
                    </div>
                  )}
                </div>
              </section>

              <section className="grid md:grid-cols-2 gap-6">
                <ListPanel
                  title={`Pendientes (${state.items.length})`}
                  items={state.items}
                  emptyHint="Carg√° √≠tems desde el panel de la izquierda"
                  onRemove={removeItem}
                />
                <ListPanel
                  title={`Sorteados (${state.drawn.length})`}
                  items={state.drawn}
                  emptyHint="A√∫n no hay sorteados"
                  onRemove={removeDrawn}
                />
              </section>

              <footer className="text-center text-xs text-neutral-500 py-8">
                Hecho con ‚ù§Ô∏è. Guardado autom√°tico en tu navegador.
              </footer>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
